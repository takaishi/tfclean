name: goreleaser test

on:
  pull_request:
    branches: [ main ]
    paths:
      - ".github/workflows/goreleaser_test.yml"
      - ".github/workflows/goreleaser.yml"

permissions:
  contents: write

jobs:
  goreleaser_test:
    runs-on: ubuntu-latest
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          repositories: |
            tfclean
            homebrew-tap
      - name: Checkout
        uses: actions/checkout@v5
        with:
          token: ${{ steps.generate_token.outputs.token }}
          fetch-depth: 0
      - name: Fetch all tags
        run: git fetch --force --tags
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: 1.25.0
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: v2.11.0
          args: release --clean --skip publish --snapshot
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
          GORELEASER_TOKEN: ${{ secrets.GORELEASER_TOKEN }}
      - name: Test version information
        run: |
          # Find the Linux amd64 binary
          echo "Searching for binary in dist directory..."
          find dist -type f -name "tfclean" | head -5
          BINARY=$(find dist -name "tfclean" -type f | grep -E "linux.*amd64|linux.*x86_64" | head -1)
          if [ -z "$BINARY" ]; then
            echo "Error: Binary not found"
            echo "Available files in dist:"
            find dist -type f | head -20
            exit 1
          fi
          
          echo "Found binary: $BINARY"
          
          # Make it executable
          chmod +x "$BINARY"
          
          # Test version output
          echo "Running: $BINARY --version"
          VERSION_OUTPUT=$("$BINARY" --version 2>&1)
          echo "Version output: '$VERSION_OUTPUT'"
          
          # Check that version is not the default "dev-HEAD"
          if [ "$VERSION_OUTPUT" = "dev-HEAD" ]; then
            echo "Error: Version information was not embedded (still shows default 'dev-HEAD')"
            echo "This indicates that ldflags were not applied correctly during build"
            exit 1
          fi
          
          # Check that version output contains a version and revision
          if ! echo "$VERSION_OUTPUT" | grep -qE '^[^-]+-[^-]+$'; then
            echo "Error: Version output format is incorrect. Expected 'version-revision' format"
            echo "Got: '$VERSION_OUTPUT'"
            exit 1
          fi
          
          echo "âœ“ Version information is correctly embedded: $VERSION_OUTPUT"
